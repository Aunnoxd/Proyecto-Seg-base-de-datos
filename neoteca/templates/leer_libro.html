{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="d-sm-flex align-items-center justify-content-between mb-3">
    <div>
        <h1 class="h4 text-gray-800 mb-0">Leyendo: <b>{{ libro.titulo }}</b></h1>
        <small class="text-muted">{{ libro.autor }}</small>
    </div>
    
    {% if rol_actual == 'ESTUDIANTE' %}
    <div class="d-flex">
        <div class="card border-left-success shadow-sm py-2 px-3 mr-3">
            <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Histórico</div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                        <span id="total-bd">{{ minutos_totales }}</span> min
                    </div>
                </div>
                <div class="col-auto"><i class="fas fa-history fa-2x text-gray-300"></i></div>
            </div>
        </div>

        <div class="card border-left-info shadow-sm py-2 px-3">
            <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Sesión Actual</div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="cronometro">00:00</div>
                </div>
                <div class="col-auto"><i class="fas fa-clock fa-2x text-gray-300"></i></div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="ml-3 text-right">
        {% if libro.archivo_pdf %}
            <a href="#" data-url="{{ libro.archivo_pdf.url }}" id="btn-descargar-final" class="btn btn-success btn-sm shadow-sm mb-1 d-block w-100">
                <i class="fas fa-check-circle"></i> Terminar y Descargar
            </a>
        {% endif %}
        <a href="{% url 'lista_libros' %}" class="btn btn-secondary btn-sm shadow-sm d-block mt-1">Volver al Catálogo</a>
    </div>
</div>

<div class="card shadow mb-4" style="height: 80vh;">
    <div class="card-body p-0 h-100 bg-dark">
        {% if libro.archivo_pdf %}
            <iframe src="{{ libro.archivo_pdf.url }}#toolbar=0" width="100%" height="100%" style="border:none;"></iframe>
        {% else %}
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-white">
                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                <h4>No hay archivo PDF cargado para este libro.</h4>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
{% if rol_actual == 'ESTUDIANTE' %}
<script>
    // Variables Globales
    let tiempoSesion = 0;    // Segundos visuales
    let tiempoPendiente = 0; // Segundos acumulados para enviar a Oracle
    const libroId = Number("{{ libro.id_libro|default:'0' }}");
    const csrfToken = "{{ csrf_token }}";
    // Usamos la URL generada por Django
    const urlAjax = "{% url 'registrar_tiempo_ajax' %}";

    // 1. RELOJ VISUAL (Se mueve cada segundo)
    setInterval(() => {
        tiempoSesion++;
        tiempoPendiente++;
        
        // Formato visual 00:00
        const min = Math.floor(tiempoSesion / 60);
        const sec = tiempoSesion % 60;
        document.getElementById('cronometro').innerText = 
            `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }, 1000);

    // 2. FUNCIÓN DE GUARDADO (AJAX)
    function guardarProgreso(esCompletado = false, accionDespues = null) {
        // Optimización: No enviar si no hay tiempo nuevo y no es una finalización
        if (tiempoPendiente <= 0 && !esCompletado) {
            if (accionDespues) accionDespues(); // Ejecutar callback aunque no guarde
            return;
        }

        const segundosAEnviar = tiempoPendiente; // Copia local
        
        fetch(urlAjax, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "X-CSRFToken": csrfToken 
            },
            body: JSON.stringify({ 
                id_libro: libroId, 
                segundos: segundosAEnviar, 
                completado: esCompletado 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                // Restar lo que ya enviamos (evita perder segundos si el fetch tarda)
                tiempoPendiente -= segundosAEnviar; 
                
                // Actualizar total histórico visual
                const totalMin = Math.round(data.nuevo_total / 60);
                const elTotal = document.getElementById('total-bd');
                if(elTotal) elTotal.innerText = totalMin;

                // Ejecutar acción posterior (ej: descargar)
                if (accionDespues) accionDespues();
            }
        })
        .catch(error => console.error("Error AJAX:", error));
    }

    // 3. GUARDADO AUTOMÁTICO (Cada 10 segundos)
    setInterval(() => guardarProgreso(false), 10000);

    // 4. GUARDADO AL CERRAR PESTAÑA (Best Effort)
    window.addEventListener('beforeunload', () => guardarProgreso(false));

    // 5. BOTÓN TERMINAR Y DESCARGAR
    const btnDescarga = document.getElementById('btn-descargar-final');
    if (btnDescarga) {
        btnDescarga.addEventListener('click', function(e) {
            e.preventDefault(); // Detenemos el link
            
            // Feedback visual
            const textoOriginal = btnDescarga.innerHTML;
            btnDescarga.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            btnDescarga.classList.add('disabled');

            // Guardamos forzando completado=true
            guardarProgreso(true, function() {
                // Cuando el servidor confirma guardado, iniciamos la descarga real
                const urlPDF = btnDescarga.getAttribute('data-url');
                
                // Abrir PDF en nueva pestaña para descargar
                window.open(urlPDF, '_blank');
                
                btnDescarga.innerHTML = '<i class="fas fa-check"></i> ¡Listo!';
                // Redirigir al catálogo después de un momento
                setTimeout(() => {
                    window.location.href = "{% url 'lista_libros' %}";
                }, 1000);
            });
        });
    }
</script>
{% endif %}
{% endblock %}